{% extends 'base.html' %}

{% block title %}Verify Email - ConnectFlow Pro{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto mt-12 text-center">
    <div class="bg-white dark:bg-gray-800 shadow-xl rounded-lg p-10">
        <div class="mb-6 flex justify-center">
            <div class="bg-indigo-100 dark:bg-indigo-900/30 p-4 rounded-full">
                <svg class="w-16 h-16 text-indigo-600 dark:text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>
                </svg>
            </div>
        </div>
        
        <h2 class="text-3xl font-bold text-gray-800 dark:text-gray-100 mb-4">Verify your email address</h2>
        
        <p class="text-gray-600 dark:text-gray-300 mb-4 text-lg">
            We've sent a verification link to <strong>{{ user.email }}</strong>.<br>
            Please check your inbox and click the link to verify your account.
        </p>
        
        <!-- Spam Folder Warning -->
        <div class="bg-yellow-50 dark:bg-yellow-900/20 border-2 border-yellow-300 dark:border-yellow-700 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                </svg>
                <div class="text-left">
                    <h3 class="font-bold text-yellow-800 dark:text-yellow-300 mb-1">⚠️ Check Your Spam Folder!</h3>
                    <p class="text-sm text-yellow-700 dark:text-yellow-400">
                        The verification email might be in your <strong>spam/junk folder</strong>. If you don't see it in your inbox within 2 minutes, please check there.
                    </p>
                </div>
            </div>
        </div>
        
        <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-lg p-4 mb-8 text-left">
            <h3 class="font-bold text-blue-800 dark:text-blue-300 mb-2 text-sm uppercase tracking-wide">Why is this required?</h3>
            <p class="text-sm text-blue-700 dark:text-blue-400">
                To ensure the security of your organization's data, we require all members to verify their identity before accessing the platform.
            </p>
        </div>

        <div class="space-y-4">
            <button id="resend-btn" class="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-8 rounded-lg transition duration-200 shadow-lg shadow-indigo-500/30">
                Resend Verification Email
            </button>
            
            <p id="feedback-msg" class="text-sm font-medium mt-4 hidden"></p>
            
            <div class="pt-6 border-t border-gray-100 dark:border-gray-700 mt-6">
                <a href="{% url 'accounts:login' %}" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-sm font-medium">
                    Back to Login
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getAuth, sendEmailVerification } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAfkKZt1a7oKZDKrPpKIGGtc6inABx5-rw",
      authDomain: "connectflowpro-f1202.firebaseapp.com",
      projectId: "connectflowpro-f1202",
      storageBucket: "connectflowpro-f1202.appspot.com",
      messagingSenderId: "184555636342",
      appId: "1:184555636342:web:a7fb46562ae779ecd58157",
      measurementId: "G-HQVJG9T8BZ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    
    const resendBtn = document.getElementById('resend-btn');
    const feedbackMsg = document.getElementById('feedback-msg');

    resendBtn.addEventListener('click', async () => {
        if (!auth.currentUser) {
            feedbackMsg.textContent = "Please sign in again to resend verification.";
            feedbackMsg.className = "text-sm font-medium mt-4 text-red-500";
            feedbackMsg.classList.remove('hidden');
            return;
        }

        resendBtn.disabled = true;
        resendBtn.classList.add('opacity-50', 'cursor-not-allowed');
        resendBtn.textContent = "Sending...";

        try {
            await sendEmailVerification(auth.currentUser, {
                url: window.location.origin + '/accounts/dashboard/',
                handleCodeInApp: false
            });
            console.log('✅ Verification email resent to:', auth.currentUser.email);
            feedbackMsg.textContent = "Verification email sent to " + auth.currentUser.email + "! Please check your inbox and spam folder.";
            feedbackMsg.className = "text-sm font-medium mt-4 text-green-600";
            feedbackMsg.classList.remove('hidden');
        } catch (error) {
            console.error('❌ Resend failed:', error);
            feedbackMsg.textContent = "Error: " + error.message + ". Please try again or contact support.";
            feedbackMsg.className = "text-sm font-medium mt-4 text-red-500";
            feedbackMsg.classList.remove('hidden');
            resendBtn.disabled = false;
            resendBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            resendBtn.textContent = "Resend Verification Email";
        }
    });
    
    // Periodically check if verified
    setInterval(async () => {
        if (auth.currentUser) {
            await auth.currentUser.reload();
            if (auth.currentUser.emailVerified) {
                // Get fresh ID token to send to backend
                const idToken = await auth.currentUser.getIdToken(true);
                
                // Tell Django to update the user's verified status
                const response = await fetch("{% url 'accounts:sync_email_verification' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({ id_token: idToken })
                });

                if (response.ok) {
                    window.location.href = "{% url 'accounts:dashboard' %}";
                }
            }
        }
    }, 5000);
</script>
{% endblock %}